<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Comprehensive Ruqyah</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&display=swap" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #4a8c4c;
            --secondary-color: #1a1a1a;
            --text-color: #f0f0f0;
            --bg-color: #2d2d2d;
            --card-bg: #3a3a3a;
            --border-radius: 10px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s ease;
        }

        .light-mode {
            --primary-color: #2c5e2e;
            --secondary-color: #f8f5e6;
            --text-color: #333;
            --bg-color: #fff;
            --card-bg: #f9f9f9;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition);
            padding-bottom: 2rem;
        }

        /* Top app bar */
        .topbar { background: #141a1c; color: #dbe4e8; padding: 0.6rem 0; box-shadow: 0 2px 8px rgba(0,0,0,0.35); position: sticky; top: 0; z-index: 10; }
        .topbar-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; }
        .topbar .brand { justify-self: center; font-weight: 700; }
        .topbar .right { justify-self: end; display: flex; align-items: center; gap: 0.75rem; }
        .topbar .home-link { color:#bfe3d0; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:0.25rem; border-radius:8px; }
        .topbar .home-link:hover { background: rgba(255,255,255,0.06); }
        .icon-link { background: none; border: none; color: #bfe3d0; font-size: 1.15rem; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 0.25rem; }
        .icon-link:hover { color: #e8fff1; }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

        .btn { padding: 0.8rem 1.2rem; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition); font-weight: bold; }
        .btn:hover { background-color: #3a6e3c; transform: translateY(-2px); }
        .btn.active { background-color: #d4af37; }

        /* Section titles */
        .section-heading { font-size: 1.2rem; font-weight: 700; margin: 1.2rem 0; opacity: 0.92; text-align:center; position:relative; }
        .section-heading::after { content:''; display:block; width:80px; height:2px; background: rgba(255,255,255,0.18); margin:0.35rem auto 0; border-radius:2px; }

        /* Cards */
        .dhikr-card { background-color: #1f2329; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35); transition: var(--transition); position: relative; }
        .dhikr-card:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(0, 0, 0, 0.45); }
        .card-number { opacity: 0.25; }

        .arabic { font-family: 'Scheherazade New', serif; font-size: 2.4rem; text-align: center; margin-bottom: 1rem; line-height: 2.0; color: #f0f4f8; direction: rtl; }
        .translation { margin-bottom: 0.75rem; font-size: 0.98rem; line-height: 1.7; color: #c3cad3; border-top: 1px solid rgba(255, 255, 255, 0.15); padding-top: 1rem; }
        .source { font-size: 0.9rem; color: #888; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .hidden { display: none; }
        .audio-controls { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; }
        .source .audio-controls { margin-top: 0; }
        .audio-btn { background: none; border: 1px solid rgba(255,255,255,0.15); color: #dbe4e8; border-radius: 999px; padding: 0.25rem 0.5rem; cursor: pointer; }
        .audio-btn:hover { filter: brightness(1.1); }
        .audio-btn.active { border-color: #d4af37; background: rgba(212,175,55,0.12); color: #fff; }
        .audio-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .dhikr-card.active-card { outline: 2px solid #d4af37; box-shadow: 0 0 0 3px rgba(212,175,55,0.25), 0 12px 28px rgba(0, 0, 0, 0.45); }

        /* Controls card for pills */
        .controls-card { background-color:#0f1215; border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:1rem; margin-bottom:1.5rem; display:flex; gap:0.6rem; justify-content:center; flex-wrap:wrap; }
        .pill-btn { background-color:#bfe3d0; color:#0c0f0f; border:none; padding:0.5rem 1rem; border-radius:999px; font-weight:600; cursor:pointer; }
        .pill-btn:hover { filter:brightness(0.95); }

        footer { text-align: center; padding: 2rem; margin-top: 3rem; border-top: 1px solid #444; color: #888; }

        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .arabic { font-size: 1.5rem; }
            .dhikr-card { padding: 1.5rem; }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Top app bar -->
    <div class="topbar">
        <div class="container topbar-grid">
            <div class="left"></div>
            <div class="brand">Comprehensive Ruqyah</div>
            <div class="right">
                <a href="index.html" class="home-link" title="Home"><i class="fas fa-home"></i></a>
                <button class="icon-link" id="toggleTranslation" title="Toggle Translation"><i class="fas fa-book"></i></button>
                <button class="icon-link" id="modeToggle" title="Toggle Dark/Light Mode"><i class="fas fa-sun"></i></button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Opening -->
        <section id="opening-section">
            <h2 class="section-heading">Opening</h2>
            <div id="opening-supplications" class="dhikr-container"></div>
        </section>

        <!-- Core (collapsible) -->
        <section id="core-section">
            <h2 class="section-heading">Core Ruqyah Verses</h2>
            <div class="controls-card"><button id="core-toggle-btn" class="pill-btn" type="button">Show</button></div>
            <div id="core-verses" class="dhikr-container" style="display:none;"></div>
        </section>

        <!-- Targeted -->
        <section id="targeted-section">
            <h2 id="targeted-title" class="section-heading">Targeted Verses</h2>
            <div id="targeted-controls" class="controls-card" aria-label="Targeted categories"></div>
            <div id="targeted-verses" class="dhikr-container"></div>
        </section>

        <!-- Closing -->
        <section id="closing-section">
            <h2 class="section-heading">Closing</h2>
            <div id="closing-supplications" class="dhikr-container"></div>
        </section>
    </div>

    <footer>
        <div class="container">
            <p>May Allah (swt) accept our du'as.</p>
        </div>
    </footer>

    <script>
        // Mode toggle
        const modeToggle = document.getElementById('modeToggle');
        const body = document.body;
        const modeIcon = modeToggle.querySelector('i');
        modeToggle.addEventListener('click', function () {
            body.classList.toggle('light-mode');
            body.classList.toggle('dark-mode');
            modeIcon.className = body.classList.contains('light-mode') ? 'fas fa-moon' : 'fas fa-sun';
        });

        // Translation toggle (bare icon in top bar)
        const toggleTranslation = document.getElementById('toggleTranslation');
        toggleTranslation.addEventListener('click', function () {
            this.classList.toggle('active');
            document.querySelectorAll('.translation').forEach(el => el.classList.toggle('hidden'));
        });

        // Helpers
        function friendlyLabelForKey(key) {
            return key.replace(/[-_]+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        function computeSource(verse) {
            if (verse.source) return verse.source;
            const hasSurah = !!verse.surah;
            const hasAyah = !!verse.verse;
            if (hasSurah && hasAyah) return `Surah ${verse.surah} (${verse.verse})`;
            if (hasSurah) return `Surah ${verse.surah}`;
            return '';
        }

        function renderVerseCard(verse, index) {
            const card = document.createElement('div');
            card.className = 'dhikr-card';

            const num = document.createElement('div');
            num.className = 'card-number';
            num.textContent = String(index + 1);
            card.appendChild(num);

            if (verse.displayArabic || verse.arabic) {
                const arEl = document.createElement('div');
                arEl.className = 'arabic';
                arEl.textContent = verse.displayArabic || verse.arabic;
                card.appendChild(arEl);
            }

            // No transliteration in this program

            if (verse.translation) {
                const tlEl = document.createElement('div');
                tlEl.className = 'translation';
                tlEl.textContent = verse.translation;
                card.appendChild(tlEl);
            }

            const srcText = computeSource(verse);
            let srcEl = null;
            if (srcText) {
                srcEl = document.createElement('div');
                srcEl.className = 'source';
                const strong = document.createElement('strong');
                strong.textContent = 'Source:';
                const srcSpan = document.createElement('span');
                srcSpan.className = 'source-text';
                srcSpan.textContent = srcText;
                srcEl.appendChild(strong);
                srcEl.appendChild(srcSpan);
                card.appendChild(srcEl);
            }

            // Optional per-verse audio (supports both `audio` and `Audio` keys)
            const audioFile = verse.audio || verse.Audio;
            if (audioFile) {
                const controls = document.createElement('div');
                controls.className = 'audio-controls';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'audio-btn';
                btn.dataset.role = 'play';
                btn.innerHTML = '<i class="fas fa-play"></i>';
                controls.appendChild(btn);

                const pauseBtn = document.createElement('button');
                pauseBtn.type = 'button';
                pauseBtn.className = 'audio-btn';
                pauseBtn.dataset.role = 'pause';
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                pauseBtn.disabled = true;
                controls.appendChild(pauseBtn);

                const repeatBtn = document.createElement('button');
                repeatBtn.type = 'button';
                repeatBtn.className = 'audio-btn';
                repeatBtn.dataset.role = 'repeat';
                repeatBtn.setAttribute('aria-pressed','false');
                repeatBtn.innerHTML = '<i class="fas fa-redo-alt"></i>';
                controls.appendChild(repeatBtn);

                const stopEndBtn = document.createElement('button');
                stopEndBtn.type = 'button';
                stopEndBtn.className = 'audio-btn';
                stopEndBtn.dataset.role = 'stopend';
                stopEndBtn.setAttribute('aria-pressed','false');
                stopEndBtn.title = 'Stop at end';
                stopEndBtn.innerHTML = '<i class="fas fa-stop-circle"></i>';
                controls.appendChild(stopEndBtn);

                const prevBtn = document.createElement('button');
                prevBtn.type = 'button';
                prevBtn.className = 'audio-btn';
                prevBtn.dataset.role = 'prev';
                prevBtn.title = 'Previous card';
                prevBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
                controls.appendChild(prevBtn);

                const nextBtn = document.createElement('button');
                nextBtn.type = 'button';
                nextBtn.className = 'audio-btn';
                nextBtn.dataset.role = 'next';
                nextBtn.title = 'Next card';
                nextBtn.innerHTML = '<i class="fas fa-arrow-right"></i>';
                controls.appendChild(nextBtn);

                const audioEl = document.createElement('audio');
                audioEl.preload = 'none';
                audioEl.src = 'audio/' + audioFile;
                // Keep audio element in DOM but visually hidden
                audioEl.style.display = 'none';
                card.appendChild(audioEl);

                function setIcon(isPlay) {
                    const icon = btn.querySelector('i');
                    if (icon) icon.className = isPlay ? 'fas fa-play' : 'fas fa-stop';
                }
                function setPauseIcon(isPlaying) {
                    const icon = pauseBtn.querySelector('i');
                    if (icon) icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
                }
                function stopActive() {
                    if (window.__activeAudio) {
                        try {
                            window.__activeAudio.pause();
                        } catch (_) {}
                        try {
                            window.__activeAudio.currentTime = 0;
                        } catch (_) {}
                        if (window.__activeBtn) {
                            const i = window.__activeBtn.querySelector('i');
                            if (i) i.className = 'fas fa-play';
                        }
                        const prevCard = window.__activeAudio.closest('.dhikr-card');
                        if (prevCard) prevCard.classList.remove('active-card');
                        const prevPause = prevCard && prevCard.querySelector('.audio-btn[data-role="pause"]');
                        if (prevPause) prevPause.disabled = true;
                        const prevPauseIcon = prevPause && prevPause.querySelector('i');
                        if (prevPauseIcon) prevPauseIcon.className = 'fas fa-pause';
                        const prevStopEnd = prevCard && prevCard.querySelector('.audio-btn[data-role="stopend"]');
                        if (prevStopEnd) {
                            prevStopEnd.setAttribute('aria-pressed','false');
                            prevStopEnd.classList.remove('active');
                        }
                    }
                    window.__activeAudio = null;
                    window.__activeBtn = null;
                }
                function highlightAndScroll(elCard) {
                    document.querySelectorAll('#core-verses .dhikr-card').forEach(c => c.classList.remove('active-card'));
                    if (elCard) {
                        elCard.classList.add('active-card');
                        elCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                // Play/Stop button
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // If this track is playing, stop it
                    if (!audioEl.paused && !audioEl.ended) {
                        try { audioEl.pause(); audioEl.currentTime = 0; } catch (_) {}
                        setIcon(true);
                        pauseBtn.disabled = true;
                        const pIcon = pauseBtn.querySelector('i');
                        if (pIcon) pIcon.className = 'fas fa-pause';
                        if (window.__activeAudio === audioEl) {
                            window.__activeAudio = null;
                            window.__activeBtn = null;
                        }
                        card.classList.remove('active-card');
                        // reset stop-at-end toggle when audio is manually stopped
                        stopEndBtn.setAttribute('aria-pressed','false');
                        stopEndBtn.classList.remove('active');
                        const repeatActive = repeatBtn.getAttribute('aria-pressed') === 'true';
                        audioEl.loop = repeatActive;
                        return;
                    }

                    // Stop any other active audio
                    if (window.__activeAudio && window.__activeAudio !== audioEl) {
                        stopActive();
                    }

                    const p = audioEl.play();
                    if (p && typeof p.catch === 'function') p.catch(() => {});
                    setIcon(false);
                    setPauseIcon(true);
                    pauseBtn.disabled = false;
                    window.__activeAudio = audioEl;
                    window.__activeBtn = btn;
                    // track current core index if applicable and highlight
                    const isCore = !!audioEl.closest('#core-verses');
                    if (isCore) {
                        const cardIndexAttr = card.getAttribute('data-index');
                        if (cardIndexAttr) window.__currentCoreIndex = Number(cardIndexAttr);
                        highlightAndScroll(card);
                    }
                    const stopActive = stopEndBtn.getAttribute('aria-pressed') === 'true';
                    const repeatActive = repeatBtn.getAttribute('aria-pressed') === 'true';
                    audioEl.loop = stopActive ? false : repeatActive;
                });

                // Pause/Resume toggle
                pauseBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (pauseBtn.disabled) return;
                    if (window.__activeAudio !== audioEl) return; // only control active track
                    if (audioEl.paused) {
                        const p = audioEl.play();
                        if (p && typeof p.catch === 'function') p.catch(() => {});
                        setPauseIcon(true);
                    } else {
                        audioEl.pause();
                        setPauseIcon(false);
                    }
                });

                // Repeat toggle (off by default)
                repeatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const active = repeatBtn.getAttribute('aria-pressed') === 'true';
                    const nextState = !active;
                    repeatBtn.setAttribute('aria-pressed', String(nextState));
                    repeatBtn.classList.toggle('active', nextState);
                    const stopActive = stopEndBtn.getAttribute('aria-pressed') === 'true';
                    audioEl.loop = stopActive ? false : nextState;
                });

                // Stop-at-end toggle (overrides repeat and auto-advance)
                stopEndBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const active = stopEndBtn.getAttribute('aria-pressed') === 'true';
                    const nextState = !active;
                    stopEndBtn.setAttribute('aria-pressed', String(nextState));
                    stopEndBtn.classList.toggle('active', nextState);
                    const repeatActive = repeatBtn.getAttribute('aria-pressed') === 'true';
                    audioEl.loop = nextState ? false : repeatActive;
                });

                // Per-card prev/next (core only, navigation without auto-play)
                prevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isCore = !!audioEl.closest('#core-verses');
                    if (!isCore) return;
                    const idxAttr = card.getAttribute('data-index');
                    const idx = idxAttr ? Number(idxAttr) : 0;
                    navigateCoreTo(idx - 1);
                });
                nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isCore = !!audioEl.closest('#core-verses');
                    if (!isCore) return;
                    const idxAttr = card.getAttribute('data-index');
                    const idx = idxAttr ? Number(idxAttr) : -1;
                    navigateCoreTo(idx + 1);
                });

                audioEl.addEventListener('ended', () => {
                    // If repeating, keep UI as playing and do not advance
                    if (audioEl.loop) return;
                    // If stop-at-end is active, stop playback and reset toggle; no auto-advance
                    const stopActive = stopEndBtn.getAttribute('aria-pressed') === 'true';
                    if (stopActive) {
                        setIcon(true);
                        pauseBtn.disabled = true;
                        const pIcon = pauseBtn.querySelector('i');
                        if (pIcon) pIcon.className = 'fas fa-pause';
                        if (window.__activeAudio === audioEl) {
                            window.__activeAudio = null;
                            window.__activeBtn = null;
                        }
                        card.classList.remove('active-card');
                        stopEndBtn.setAttribute('aria-pressed','false');
                        stopEndBtn.classList.remove('active');
                        const repeatActive = repeatBtn.getAttribute('aria-pressed') === 'true';
                        audioEl.loop = repeatActive;
                        return;
                    }
                    // Otherwise, normal end: stop UI and auto-advance for core verses
                    setIcon(true);
                    pauseBtn.disabled = true;
                    const pIcon = pauseBtn.querySelector('i');
                    if (pIcon) pIcon.className = 'fas fa-pause';
                    if (window.__activeAudio === audioEl) {
                        window.__activeAudio = null;
                        window.__activeBtn = null;
                    }
                    card.classList.remove('active-card');
                    const isCore = !!audioEl.closest('#core-verses');
                    if (isCore) {
                        advanceFromAudio(audioEl);
                    }
                });
                audioEl.addEventListener('error', () => {
                    setIcon(true);
                    pauseBtn.disabled = true;
                    const pIcon = pauseBtn.querySelector('i');
                    if (pIcon) pIcon.className = 'fas fa-pause';
                    if (window.__activeAudio === audioEl) {
                        window.__activeAudio = null;
                        window.__activeBtn = null;
                    }
                    card.classList.remove('active-card');
                    stopEndBtn.setAttribute('aria-pressed','false');
                    stopEndBtn.classList.remove('active');
                    const repeatActive = repeatBtn.getAttribute('aria-pressed') === 'true';
                    audioEl.loop = repeatActive;
                });

                (srcEl || card).appendChild(controls);
            }

            // store index for core navigation
            card.setAttribute('data-index', String(index));

            return card;
        }

        function renderSection(containerEl, versesArray) {
            containerEl.innerHTML = '';
            if (!Array.isArray(versesArray)) return;
            versesArray.forEach((v, i) => {
                containerEl.appendChild(renderVerseCard(v, i));
            });
            // Re-apply current toggle states to newly rendered content
            if (document.getElementById('toggleTranslation').classList.contains('active')) {
                containerEl.querySelectorAll('.translation').forEach(el => el.classList.add('hidden'));
            }
        }

        // Core collapsible setup
        function setupCoreToggle(data) {
            const btn = document.getElementById('core-toggle-btn');
            const container = document.getElementById('core-verses');
            let shown = false;
            btn.textContent = 'Show';
            btn.addEventListener('click', () => {
                shown = !shown;
                btn.textContent = shown ? 'Hide' : 'Show';
                container.style.display = shown ? '' : 'none';
                if (shown && container.children.length === 0) {
                    renderSection(container, data.coreVerses);
                }
            });
        }

        function setupTargetedControls(data) {
            const controlsEl = document.getElementById('targeted-controls');
            const titleEl = document.getElementById('targeted-title');
            const targetedContainer = document.getElementById('targeted-verses');
            controlsEl.innerHTML = '';
            titleEl.textContent = 'Targeted Verses';
            targetedContainer.innerHTML = '';

            const categories = data && data.targetedVerses ? Object.keys(data.targetedVerses) : [];
            if (categories.length === 0) return;

            let activeKey = null;
            let isShown = false;
            targetedContainer.style.display = 'none';

            categories.forEach((key) => {
                const btn = document.createElement('button');
                btn.className = 'pill-btn';
                btn.type = 'button';
                btn.textContent = friendlyLabelForKey(key);
                btn.addEventListener('click', () => {
                    // Toggle if clicking the same active category while shown
                    if (activeKey === key && isShown) {
                        targetedContainer.style.display = 'none';
                        isShown = false;
                        activeKey = null;
                        titleEl.textContent = 'Targeted Verses';
                        [...controlsEl.querySelectorAll('button')].forEach(b => b.classList.remove('active'));
                        return;
                    }

                    // Show selected category
                    activeKey = key;
                    titleEl.textContent = friendlyLabelForKey(key);
                    renderSection(targetedContainer, data.targetedVerses[key]);
                    targetedContainer.style.display = '';
                    isShown = true;
                    [...controlsEl.querySelectorAll('button')].forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
                controlsEl.appendChild(btn);
            });
        }

        async function loadVerses() {
            const res = await fetch('data/verses.json', { cache: 'no-cache' });
            if (!res.ok) throw new Error('Failed to load verses.json');
            return res.json();
        }

        async function initVersesUI() {
            try {
                const data = await loadVerses();

                // Opening
                const openingContainer = document.getElementById('opening-supplications');
                renderSection(openingContainer, (data.supplications && data.supplications.opening) || []);

                // Core collapsible
                setupCoreToggle(data);

                // Targeted controls & verses
                setupTargetedControls(data);

                // Closing
                const closingContainer = document.getElementById('closing-supplications');
                renderSection(closingContainer, (data.supplications && data.supplications.closing) || []);
            } catch (err) {
                console.error(err);
                const openingContainer = document.getElementById('opening-supplications');
                openingContainer.innerHTML = '<p class="translation">Unable to load verses.json. Please check the server and file path.</p>';
            }
        }

        // Initialize
        initVersesUI();

        function getCoreAudioList() {
            return Array.from(document.querySelectorAll('#core-verses audio'));
        }
        function navigateCoreTo(index) {
            const list = getCoreAudioList();
            if (list.length === 0) return;
            const idx = (index % list.length + list.length) % list.length;
            const target = list[idx];
            const card = target.closest('.dhikr-card');
            if (card) {
                document.querySelectorAll('#core-verses .dhikr-card').forEach(c => c.classList.remove('active-card'));
                card.classList.add('active-card');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                window.__currentCoreIndex = idx;
            }
        }
        function playCoreAt(index) {
            const list = getCoreAudioList();
            if (list.length === 0) return;
            const idx = (index % list.length + list.length) % list.length;
            const target = list[idx];
            const card = target.closest('.dhikr-card');
            const playBtn = card && card.querySelector('.audio-btn[data-role="play"]');
            if (playBtn) {
                playBtn.click();
                window.__currentCoreIndex = idx;
            }
        }
        function advanceFromAudio(audioEl) {
            const list = getCoreAudioList();
            if (list.length === 0) return;
            const idx = list.indexOf(audioEl);
            const next = (idx + 1) % list.length;
            playCoreAt(next);
        }
        function setupCoreNavControls() {
            const prevBtn = document.getElementById('core-prev-btn');
            const nextBtn = document.getElementById('core-next-btn');
            if (!prevBtn || !nextBtn) return;
            prevBtn.addEventListener('click', () => {
                const list = getCoreAudioList();
                if (list.length === 0) return;
                const idx = typeof window.__currentCoreIndex === 'number' ? window.__currentCoreIndex : 0;
                playCoreAt(idx - 1);
            });
            nextBtn.addEventListener('click', () => {
                const list = getCoreAudioList();
                if (list.length === 0) return;
                const idx = typeof window.__currentCoreIndex === 'number' ? window.__currentCoreIndex : -1;
                playCoreAt(idx + 1);
            });
        }
    </script>
</body>
</html>